name: CD

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: CD –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–¥ –ø–æ–ø–∞–ª –≤ main/master
    # Branch Protection –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ CI –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥ –º–µ—Ä–¥–∂–µ–º
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.16.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Build project
        run: pnpm build

      # –í–ê–†–ò–ê–ù–¢ 1: –ï—Å–ª–∏ —É Render –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω auto-deploy –∏–∑ GitHub
      # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —ç—Ç–æ—Ç –±–ª–æ–∫ –∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –í–ê–†–ò–ê–ù–¢ 2
      # - name: Deploy to Render (via API)
      #   if: success()
      #   env:
      #     RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      #     RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      #   run: |
      #     echo "üöÄ Triggering Render deployment via API..."
      #     RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
      #       -H "Authorization: Bearer $RENDER_API_KEY" \
      #       -H "Content-Type: application/json")
      #     
      #     HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      #     BODY=$(echo "$RESPONSE" | sed '$d')
      #     
      #     if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
      #       echo "‚úÖ Deployment triggered successfully!"
      #       echo "$BODY" | jq '.' || echo "$BODY"
      #     else
      #       echo "‚ùå Failed to trigger deployment. HTTP $HTTP_CODE"
      #       echo "$BODY"
      #       exit 1
      #     fi

      # –í–ê–†–ò–ê–ù–¢ 2: –ï—Å–ª–∏ —É Render –£–ñ–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω auto-deploy –∏–∑ GitHub
      # Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –ø—Ä–∏ push –≤ main/master
      # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–¥ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é
      - name: Verify deployment readiness
        if: success()
        run: |
          echo "‚úÖ Code is ready for deployment"
          echo "üöÄ Render will auto-deploy from GitHub (if configured)"
          echo "üìù Make sure Render service has 'Auto-Deploy' enabled for main/master branch"

      # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º:
      # - name: Deploy to Heroku
      #   uses: akhileshns/heroku-deploy@v3.13.15
      #   with:
      #     heroku_api_key: ${{secrets.HEROKU_API_KEY}}
      #     heroku_app_name: "your-app-name"
      #     heroku_email: "your-email@example.com"

